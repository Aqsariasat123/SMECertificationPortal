// Prisma Schema for SME Certification Portal
// This schema defines all models for the certification and registry system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  user
  sme
  admin
}

enum CertificationStatus {
  draft
  submitted
  under_review
  certified
  rejected
  revision_requested
}

enum RequestStatus {
  pending
  viewed
  responded
}

enum SupportTicketStatus {
  open
  in_progress
  resolved
  closed
}

enum SupportTicketPriority {
  low
  medium
  high
}

enum InvestorType {
  individual
  company
}

enum KycStatus {
  not_submitted
  pending
  approved
  rejected
  revision_requested
}

enum IndustrySector {
  technology
  healthcare
  finance
  retail
  manufacturing
  real_estate
  hospitality
  education
  other
}

enum LegalStructure {
  llc
  partnership
  sole_proprietorship
  corporation
  free_zone
  branch
  other
}

enum BusinessModel {
  b2b
  b2c
  b2b2c
  marketplace
  saas
  other
}

enum FundingStage {
  bootstrapped
  pre_seed
  seed
  series_a
  series_b
  series_c_plus
  profitable
  other
}

enum OfficeType {
  own_premises
  rented
  shared_coworking
  virtual
  home_based
}

enum CertificateStatus {
  active
  expired
  revoked
}

enum PaymentStatus {
  not_requested     // No payment requested yet
  pending           // Payment requested, awaiting SME payment
  processing        // Payment being processed
  completed         // Payment successful
  failed            // Payment failed
  refunded          // Payment refunded
}

enum DocumentStatus {
  pending           // Not yet reviewed
  approved          // Admin approved this document
  requires_revision // Admin flagged for revision
}

enum EmailStatus {
  sent              // Email sent successfully
  failed            // Email failed to send
}

enum AccountStatus {
  active            // Account is active and can login
  suspended         // Account is suspended by admin, cannot login
}

enum AuthProvider {
  local             // Email/password registration
  google            // Google OAuth
  uaepass           // UAE Pass authentication
}

enum TwoFactorMethod {
  email             // OTP sent via email
  sms               // OTP sent via SMS
  totp              // Time-based OTP (Google Authenticator, etc.)
}

// ============================================
// CERTIFICATION SCORING ENUMS
// ============================================

enum CriterionRating {
  not_rated         // Not yet assessed
  green             // 3 points - No material risk
  amber             // 2 points - Remediable risk
  red               // 1 point - Structural/non-remediable risk
}

enum PillarStatus {
  not_started       // Assessment not begun
  in_progress       // Partially assessed
  pass              // Score >= 2.50, no auto-fail
  conditional       // Score 2.00-2.49 or specific conditions
  fail              // Score < 2.00 or auto-fail triggered
}

enum CertificationOutcome {
  pending           // Assessment not complete
  certified         // All pillars PASS
  conditional_certification  // One or more CONDITIONAL, no FAIL
  not_certified     // Any FAIL or auto-fail triggered
}

// ============================================
// MODELS
// ============================================

/// User model - Base user account for all roles
model User {
  id                    String        @id @default(uuid())
  email                 String        @unique
  password              String
  role                  UserRole
  fullName              String
  phoneNumber           String?
  profilePicture        String?
  isVerified            Boolean       @default(false)
  verificationToken     String?
  resetPasswordToken    String?
  resetPasswordExpires  DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  lastLogin             DateTime?

  // OAuth / Social Login
  authProvider          AuthProvider  @default(local)
  providerId            String?       // OAuth provider's user ID (Google sub, UAE Pass ID)

  // Two-Factor Authentication
  twoFactorEnabled      Boolean       @default(false)
  twoFactorSecret       String?       // For TOTP secret or temporary OTP
  twoFactorMethod       TwoFactorMethod?
  twoFactorVerifiedAt   DateTime?     // Last 2FA verification timestamp

  // Account Status (Governance Control)
  accountStatus         AccountStatus @default(active)
  suspendedAt           DateTime?
  suspendedBy           String?       // Admin user ID who suspended
  suspendedReason       String?

  // Relations
  userProfile           UserProfile?
  smeProfile            SMEProfile?
  reviewedApplications  SMEProfile[]          @relation("ReviewedBy")
  introductionRequests  IntroductionRequest[] @relation("Requester")
  auditLogs             AuditLog[]
  sentMessages          ChatMessage[]         @relation("MessageSender")
  supportTickets        SupportTicket[]       @relation("TicketCreator")
  supportMessages       SupportMessage[]      @relation("SupportMessageSender")
  issuedCertificates    Certificate[]         @relation("IssuedCertificates")
  requestedPayments     Payment[]             @relation("PaymentRequestedBy")
  reviewedDocuments     DocumentVersion[]     @relation("DocumentReviewedBy")
  pillarAssessments     PillarAssessment[]    @relation("PillarAssessedBy")
  certificationDecisions CertificationDecision[] @relation("DecisionMadeBy")

  @@map("users")
}

/// UserProfile model - Extended profile for Investors (Individual or Company)
model UserProfile {
  id                String        @id @default(uuid())
  userId            String        @unique

  // ============ INVESTOR TYPE ============
  investorType      InvestorType? // individual or company (optional selection)

  // ============ INDIVIDUAL INVESTOR KYC ============
  // Personal Info
  nationality       String?
  dateOfBirth       DateTime?
  gender            String?       // male, female, other
  residencyStatus   String?       // citizen, resident, visitor

  // Identification
  emiratesId        String?       // Emirates ID number
  emiratesIdExpiry  DateTime?
  passportNumber    String?
  passportExpiry    DateTime?
  passportCountry   String?       // Country of passport issuance

  // Address
  residentialAddress String?
  city              String?
  country           String?
  poBox             String?

  // Employment / Source of Funds
  employmentStatus  String?       // employed, self_employed, retired, student, other
  employerName      String?
  occupation        String?
  annualIncome      String?       // income range
  sourceOfFunds     String?       // salary, business, inheritance, investments, other

  // ============ COMPANY INVESTOR KYC ============
  // Company Info
  companyName       String?
  companyType       String?       // llc, corporation, partnership, free_zone, other
  tradeLicenseNumber String?
  tradeLicenseExpiry DateTime?
  registrationNumber String?      // Commercial registration number
  registrationDate  DateTime?
  registrationAuthority String?   // DED, JAFZA, etc.

  // Company Address
  companyAddress    String?
  companyCity       String?
  companyCountry    String?
  companyPoBox      String?

  // Authorized Representative
  authRepName       String?       // Authorized representative name
  authRepPosition   String?       // Position/title
  authRepEmiratesId String?
  authRepEmail      String?
  authRepPhone      String?

  // Beneficial Owners (UBO)
  beneficialOwners  Json?         // Array of { name, nationality, ownershipPercent, emiratesId }

  // Company Financials
  companyAnnualRevenue String?    // Revenue range
  companyEmployeeCount Int?

  // ============ KYC STATUS & DOCUMENTS ============
  kycStatus         KycStatus     @default(not_submitted)
  kycDocuments      Json?         // Array of { type, name, path, uploadedAt }
  kycSubmittedAt    DateTime?
  kycReviewedAt     DateTime?
  kycReviewedBy     String?       // Admin user ID
  kycRejectionReason String?
  kycRevisionNotes  String?

  // ============ INVESTMENT PREFERENCES (Optional) ============
  investmentInterests Json?       // Array of sector preferences
  investmentBudget  String?       // Budget range
  riskTolerance     String?       // low, medium, high

  // Legacy fields (keeping for compatibility)
  company           String?       // Deprecated - use companyName
  jobTitle          String?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

/// SMEProfile model - Company profile for SME certification
model SMEProfile {
  id                  String              @id @default(uuid())
  userId              String              @unique

  // ============ BASIC INFO (Existing + Enhanced) ============
  companyName         String?
  tradeLicenseNumber  String?             @unique  // Governance: Prevent duplicate registrations
  companyDescription  String?
  industrySector      IndustrySector?
  foundingDate        DateTime?
  employeeCount       Int?
  annualRevenue       Decimal?            @db.Decimal(15, 2)
  website             String?
  address             String?

  // ============ LEGAL & REGISTRATION (Required) ============
  registrationNumber  String?             // Company registration / CR number
  vatNumber           String?             // VAT / Tax registration number
  licenseExpiryDate   DateTime?           // Trade license expiry
  legalStructure      LegalStructure?     // LLC, Partnership, etc.
  registrationCountry String?             // Country of incorporation
  registrationCity    String?             // City of registration

  // ============ OWNERSHIP & MANAGEMENT (Required) ============
  ownerName           String?             // Primary owner / CEO name
  ownerNationality    String?             // Owner's nationality
  ownerIdNumber       String?             // Emirates ID / National ID
  shareholderStructure Json?              // Array of { name, nationality, percentage }
  boardMembers        Json?               // Array of { name, position, nationality }

  // ============ FINANCIAL INFO (Optional) ============
  bankName            String?             // Company's primary bank
  bankAccountNumber   String?             // Masked account number for verification
  auditorName         String?             // External auditor name
  lastAuditDate       DateTime?           // Date of last audit
  profitMargin        Decimal?            @db.Decimal(5, 2) // Percentage
  fundingStage        FundingStage?       // Bootstrapped, Seed, Series A, etc.

  // ============ BUSINESS OPERATIONS (Optional) ============
  businessModel       BusinessModel?      // B2B, B2C, etc.
  operatingCountries  Json?               // Array of country names
  majorClients        Json?               // Array of client names (optional)
  officeType          OfficeType?         // Own premises, Virtual, etc.

  // ============ COMPLIANCE & CERTIFICATIONS (Optional) ============
  existingCertifications Json?            // Array of { name, issuedBy, validUntil }
  regulatoryLicenses  Json?               // Array of { name, licenseNumber, validUntil }
  complianceOfficerName String?           // Compliance officer name
  complianceOfficerEmail String?          // Compliance officer email
  hasAmlPolicy        Boolean             @default(false)
  hasDataProtectionPolicy Boolean         @default(false)

  // ============ CONTACT & SOCIAL (Optional) ============
  linkedinUrl         String?
  socialMedia         Json?               // { twitter, facebook, instagram }
  headOfficeAddress   String?             // Detailed head office address
  headOfficeLatitude  Decimal?            @db.Decimal(10, 8)
  headOfficeLongitude Decimal?            @db.Decimal(11, 8)
  secondaryContactName String?
  secondaryContactPhone String?
  secondaryContactEmail String?

  // ============ SYSTEM FIELDS ============
  documents           Json?               // Array of document file paths
  certificationStatus CertificationStatus @default(draft)
  submittedDate       DateTime?
  reviewedById        String?
  revisionNotes       String?
  listingVisible      Boolean             @default(false)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // ============ INTERNAL REVIEW (Admin-only) ============
  internalDimensions  Json?               // { dimension1: status, dimension2: status, ... }
  internalNotes       String?             @db.Text // Admin internal notes (not visible to SME)
  internalReviewStartedAt DateTime?       // When admin started review
  lastInternalReviewAt DateTime?          // When admin last updated internal review

  // Relations
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewedBy             User?                   @relation("ReviewedBy", fields: [reviewedById], references: [id])
  introductionRequests   IntroductionRequest[]
  certificates           Certificate[]
  payments               Payment[]
  documentVersions       DocumentVersion[]
  pillarAssessments      PillarAssessment[]
  certificationDecision  CertificationDecision?

  @@map("sme_profiles")
}

/// Certificate model - Registry-grade digital credentials for certified SMEs
model Certificate {
  id                  String            @id @default(uuid())
  certificateId       String            @unique // SME-CERT-XXXXXXXX (8 random hex chars)
  certificateVersion  String            @default("v1.0")
  smeProfileId        String

  // Certificate Data (snapshot at time of issuance)
  companyName         String
  tradeLicenseNumber  String
  industrySector      String

  // Validity
  issuedAt            DateTime          @default(now())
  expiresAt           DateTime          // +12 months from issuance
  status              CertificateStatus @default(active)

  // Revocation (if applicable)
  revokedAt           DateTime?
  revocationReason    String?

  // Verification
  verificationUrl     String            // Full URL to public verification page
  verificationHash    String            // SHA-256 hash of certificate data

  // Issuer
  issuedById          String            // Admin who approved the application

  // Reissuance tracking
  lastReissuedAt      DateTime?

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  smeProfile          SMEProfile        @relation(fields: [smeProfileId], references: [id], onDelete: Cascade)
  issuedBy            User              @relation("IssuedCertificates", fields: [issuedById], references: [id])

  @@index([certificateId])
  @@index([smeProfileId])
  @@index([status])
  @@map("certificates")
}

/// IntroductionRequest model - Requests from users to connect with SMEs
model IntroductionRequest {
  id                 String        @id @default(uuid())
  requesterId        String
  smeProfileId       String
  message            String
  contactPreferences String?
  status             RequestStatus @default(pending)
  smeResponse        String?       // SME owner's response message
  respondedAt        DateTime?     // When SME responded
  requestedDate      DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  requester  User          @relation("Requester", fields: [requesterId], references: [id], onDelete: Cascade)
  smeProfile SMEProfile    @relation(fields: [smeProfileId], references: [id], onDelete: Cascade)
  messages   ChatMessage[]

  @@map("introduction_requests")
}

/// ChatMessage model - Messages in introduction request conversations
model ChatMessage {
  id                    String              @id @default(uuid())
  introductionRequestId String
  senderId              String
  content               String?             // Text content (optional if file attached)
  createdAt             DateTime            @default(now())
  isRead                Boolean             @default(false)
  isEdited              Boolean             @default(false)
  editedAt              DateTime?
  isDeletedForEveryone  Boolean             @default(false)
  deletedForUsers       Json                @default("[]") // Array of user IDs who deleted for themselves

  // Relations
  introductionRequest IntroductionRequest @relation(fields: [introductionRequestId], references: [id], onDelete: Cascade)
  sender              User                @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  attachments         ChatAttachment[]

  @@index([introductionRequestId])
  @@index([senderId])
  @@map("chat_messages")
}

/// ChatAttachment model - File attachments in chat messages
model ChatAttachment {
  id           String      @id @default(uuid())
  messageId    String
  fileName     String
  originalName String
  filePath     String
  fileSize     Int
  mimeType     String
  createdAt    DateTime    @default(now())

  // Relations
  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("chat_attachments")
}

/// AuditLog model - Immutable audit trail for all actions
model AuditLog {
  id                String   @id @default(uuid())
  userId            String
  actionType        String
  actionDescription String
  targetType        String?
  targetId          String?
  ipAddress         String?
  timestamp         DateTime @default(now())
  previousValue     String?  // JSON string
  newValue          String?  // JSON string

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([actionType])
  @@index([timestamp])
  @@map("audit_logs")
}

/// LegalPage model - Dynamic legal/trust pages (Terms, Privacy, Legal Notice, Contact)
model LegalPage {
  id          String   @id @default(uuid())
  slug        String   @unique // terms, privacy, legal-notice, contact
  title       String
  content     String   @db.Text
  isPublished Boolean  @default(true)
  lastUpdated DateTime @default(now())
  updatedBy   String?  // Admin user ID who last edited
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("legal_pages")
}

/// Payment model - Certification fee payments
model Payment {
  id                  String        @id @default(uuid())
  paymentId           String        @unique // PAY-XXXXXXXX (8 random hex chars)
  smeProfileId        String

  // Payment Details
  amount              Decimal       @db.Decimal(10, 2)
  currency            String        @default("AED")
  description         String        @default("SME Certification Fee")

  // Status
  status              PaymentStatus @default(not_requested)

  // Stripe Integration
  stripePaymentIntentId String?     // Stripe Payment Intent ID
  stripeClientSecret    String?     // For frontend payment form
  stripeChargeId        String?     // Stripe Charge ID after successful payment

  // Admin Control
  requestedById       String?       // Admin who requested payment
  requestedAt         DateTime?     // When payment was requested

  // Payment Completion
  paidAt              DateTime?     // When payment was completed
  failedAt            DateTime?     // When payment failed
  failureReason       String?       // Reason for failure

  // Invoice/Receipt
  invoiceNumber       String?       // NAIWA-INV-XXXXXXXX
  receiptUrl          String?       // URL to payment receipt

  // Timestamps
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  smeProfile          SMEProfile    @relation(fields: [smeProfileId], references: [id], onDelete: Cascade)
  requestedBy         User?         @relation("PaymentRequestedBy", fields: [requestedById], references: [id])

  @@index([smeProfileId])
  @@index([status])
  @@index([paymentId])
  @@map("payments")
}

/// SupportTicket model - Support conversations between users/SMEs and admin
model SupportTicket {
  id          String                 @id @default(uuid())
  userId      String
  subject     String
  status      SupportTicketStatus    @default(open)
  priority    SupportTicketPriority  @default(medium)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  closedAt    DateTime?

  // Relations
  user        User                   @relation("TicketCreator", fields: [userId], references: [id], onDelete: Cascade)
  messages    SupportMessage[]

  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

/// SupportMessage model - Messages in support ticket conversations
model SupportMessage {
  id          String    @id @default(uuid())
  ticketId    String
  senderId    String
  content     String
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())

  // Relations
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender      User          @relation("SupportMessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([senderId])
  @@map("support_messages")
}

/// DocumentVersion model - Tracks document upload history with versions
model DocumentVersion {
  id            String         @id @default(uuid())
  smeProfileId  String
  documentType  String         // trade_license, financial_statements, etc.
  originalName  String         // Original filename uploaded
  fileName      String         // Stored filename on disk
  filePath      String         // Full path to file
  fileSize      Int?           // File size in bytes
  mimeType      String?        // MIME type of the file
  version       Int            @default(1)
  status        DocumentStatus @default(pending)
  adminFeedback String?        // Admin feedback for this document
  reviewedById  String?        // Admin who reviewed
  reviewedAt    DateTime?      // When reviewed
  uploadedAt    DateTime       @default(now())
  replacedAt    DateTime?      // When this version was replaced by a newer one
  isLatest      Boolean        @default(true) // Is this the latest version

  // Relations
  smeProfile    SMEProfile     @relation(fields: [smeProfileId], references: [id], onDelete: Cascade)
  reviewedBy    User?          @relation("DocumentReviewedBy", fields: [reviewedById], references: [id])

  @@index([smeProfileId])
  @@index([documentType])
  @@index([isLatest])
  @@map("document_versions")
}

/// EmailLog model - Logs all email activity for audit purposes
model EmailLog {
  id             String      @id @default(uuid())
  recipientEmail String
  recipientName  String?
  entityType     String      // sme, user, admin, investor
  entityId       String?     // Related entity ID (userId, smeProfileId, etc.)
  eventType      String      // welcome, verification, approval, rejection, etc.
  subject        String
  templateId     String?     // Email template used
  status         EmailStatus @default(sent)
  errorMessage   String?     // Error message if failed
  metadata       Json?       // Additional context (e.g., { companyName, applicationId })
  sentAt         DateTime    @default(now())

  @@index([recipientEmail])
  @@index([entityType, entityId])
  @@index([eventType])
  @@index([status])
  @@index([sentAt])
  @@map("email_logs")
}

// ============================================
// CERTIFICATION SCORING MODELS
// ============================================

/// PillarAssessment model - Detailed scoring for each of the 5 certification pillars
model PillarAssessment {
  id                  String        @id @default(uuid())
  smeProfileId        String
  pillarNumber        Int           // 1-5
  pillarName          String        // e.g., "Legal & Ownership Readiness"
  pillarWeight        Decimal       @db.Decimal(5,4) // e.g., 0.25 for 25%

  // Status and scoring
  status              PillarStatus  @default(not_started)
  weightedScore       Decimal?      @db.Decimal(5,2) // Calculated pillar score (1.00 - 3.00)

  // Auto-fail tracking
  autoFailTriggered   Boolean       @default(false)
  autoFailReason      String?       @db.Text
  autoFailCriteria    Json?         // Array of criteria codes that triggered auto-fail

  // Sub-criteria scores - JSON structure:
  // [{ code: "1.1", name: "Legal Existence", weight: 0.25, rating: "green"|"amber"|"red"|"not_rated", notes: "..." }, ...]
  subCriteriaScores   Json?

  // Assessor info
  assessorNotes       String?       @db.Text
  assessedById        String?
  assessedAt          DateTime?

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  smeProfile          SMEProfile    @relation(fields: [smeProfileId], references: [id], onDelete: Cascade)
  assessedBy          User?         @relation("PillarAssessedBy", fields: [assessedById], references: [id])

  @@unique([smeProfileId, pillarNumber])
  @@index([smeProfileId])
  @@index([status])
  @@map("pillar_assessments")
}

/// CertificationDecision model - Final certification outcome and decision audit trail
model CertificationDecision {
  id                      String              @id @default(uuid())
  smeProfileId            String              @unique

  // Final outcome
  outcome                 CertificationOutcome @default(pending)

  // Decision factors
  globalAutoFail          Boolean             @default(false)
  globalAutoFailPillar    Int?                // Which pillar triggered global auto-fail (e.g., Pillar 5)
  globalAutoFailReason    String?             @db.Text

  // Pillar results summary
  pillar1Status           PillarStatus        @default(not_started)
  pillar1Score            Decimal?            @db.Decimal(5,2)
  pillar2Status           PillarStatus        @default(not_started)
  pillar2Score            Decimal?            @db.Decimal(5,2)
  pillar3Status           PillarStatus        @default(not_started)
  pillar3Score            Decimal?            @db.Decimal(5,2)
  pillar4Status           PillarStatus        @default(not_started)
  pillar4Score            Decimal?            @db.Decimal(5,2)
  pillar5Status           PillarStatus        @default(not_started)
  pillar5Score            Decimal?            @db.Decimal(5,2)

  // Overall weighted score (sum of pillar scores * weights)
  overallWeightedScore    Decimal?            @db.Decimal(5,2)

  // Decision metadata
  decidedAt               DateTime?
  decidedById             String?
  decisionNotes           String?             @db.Text
  decisionPath            String?             // Which rule triggered: "auto_fail_p5", "pillar_fail", "conditional", "clean_pass"

  // Regulatory disclaimer (must be included on certificate)
  disclaimerAcknowledged  Boolean             @default(false)

  // Remediation tracking (for CONDITIONAL outcomes)
  remediationRequired     Json?               // Array of { pillarNumber, criteria, action }
  remediationDeadline     DateTime?

  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  // Relations
  smeProfile              SMEProfile          @relation(fields: [smeProfileId], references: [id], onDelete: Cascade)
  decidedBy               User?               @relation("DecisionMadeBy", fields: [decidedById], references: [id])

  @@index([outcome])
  @@index([smeProfileId])
  @@map("certification_decisions")
}
